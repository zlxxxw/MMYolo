import os
from ultralytics import YOLO  # ä¿®æ­£å¯¼å…¥æ–¹å¼
import pandas as pd

# ================= ğŸ”¬ è®ºæ–‡å®éªŒæ ¸å¿ƒé…ç½® =================
# 1. æ•°æ®é›†é…ç½®æ–‡ä»¶è·¯å¾„
# ä¿®æ­£ï¼šæ ¹æ®æˆªå›¾ï¼Œdata.yaml å°±åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œç›´æ¥å¼•ç”¨æ–‡ä»¶åå³å¯
DATASET_YAML = 'data.yaml'  

# 2. å®éªŒé¡¹ç›®åç§° (è¾“å‡ºæ–‡ä»¶å¤¹å)
PROJECT_NAME = 'Airport_GSE_Detection_Research'

# 3. å¯¹æ¯”æ¨¡å‹åˆ—è¡¨ (ä½ æŒ‡å®šçš„7ä¸ªæ¨¡å‹)
models_config = {
    'YOLOv5n': 'yolov5n.pt',   # Nanoç‰ˆ: æå°ï¼Œé€Ÿåº¦å¿«
    'YOLOv5s': 'yolov5s.pt',   # Smallç‰ˆ: ç²¾åº¦æ¯”né«˜ï¼Œå‚æ•°é‡ç¨å¤§ (å¢åŠ è¿™ä¸ªå¯¹æ¯”éå¸¸æœ‰æ„ä¹‰)
    'YOLOv6n': 'yolov6n.pt',    # ä¸“æ³¨äºæ¨ç†FPSçš„å·¥ä¸šæ¨¡å‹
    'YOLOv8s': 'yolov8s.pt',    # ç›®å‰åº”ç”¨æœ€å¹¿æ³›çš„æ ‡å‡†
    'YOLOv8n': 'yolov8n.pt',    # ç›®å‰åº”ç”¨æœ€å¹¿æ³›çš„æ ‡å‡†
    'YOLOv9t': 'yolov9t.pt',    # PGIæ¶æ„ï¼Œä¼˜åŒ–ç‰¹å¾ä¼ è¾“
    'YOLOv10n': 'yolov10n.pt',  # æ— NMSæŠ€æœ¯ï¼Œç«¯åˆ°ç«¯æ£€æµ‹
    'YOLOv11n': 'yolov11n.pt'    # 2024/2025 æœ€æ–°æœ€å¼ºç‰ˆæœ¬
}

# 4. ç§‘ç ”çº§è¶…å‚æ•° (é’ˆå¯¹ 4ç±»æœºåœºåœ°å‹¤ç›®æ ‡ + 500å¼ å°æ ·æœ¬ä¼˜åŒ–)
# ================= ğŸ”¬ ç§‘ç ”çº§è¯¦ç»†è¶…å‚æ•°é…ç½® (é’ˆå¯¹500å¼ å°æ ·æœ¬ä¼˜åŒ–) =================
HYPERPARAMS = {
    # --- 1. è®­ç»ƒæ—¶é•¿ä¸æ—©åœç­–ç•¥ ---
    'epochs': 300,          # æ€»è½®æ¬¡ï¼šå°æ•°æ®å»ºè®®è·‘ä¹…ä¸€ç‚¹(300)ï¼Œè®©æ¨¡å‹å……åˆ†å­¦ä¹ å¢å¼ºåçš„æ•°æ®
    'patience': 50,         # æ—©åœæœºåˆ¶ï¼šå¦‚æœéªŒè¯é›† mAP åœ¨ 50 è½®å†…ä¸ä¸Šå‡ï¼Œæå‰åœæ­¢ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
    'batch': 16,            # æ‰¹æ¬¡å¤§å°ï¼šå°æ ·æœ¬æ¨è 16ã€‚è¾ƒå°çš„ batch èƒ½å¸¦æ¥ä¸€å®šçš„å™ªå£°ï¼Œæœ‰åŠ©äºæ³›åŒ–

    # --- 2. ä¼˜åŒ–å™¨ä¸å­¦ä¹ ç‡ (æ ¸å¿ƒ) ---
    'optimizer': 'auto',    # ä¼˜åŒ–å™¨ï¼š'auto'é€šå¸¸ä¼šé€‰æ‹© SGDã€‚SGDåœ¨CVä»»åŠ¡ä¸Šæ³›åŒ–æ€§é€šå¸¸ä¼˜äº Adam
    'lr0': 0.01,            # åˆå§‹å­¦ä¹ ç‡ï¼šSGD é»˜è®¤ä¸º 0.01ã€‚å¦‚æœæ˜¯ AdamWï¼Œé€šå¸¸å»ºè®® 0.001
    'lrf': 0.01,            # æœ€ç»ˆå­¦ä¹ ç‡ï¼šlr0 * lrfã€‚è¿™é‡ŒæŒ‡æœ€ç»ˆè¡°å‡åˆ° 0.01 * 0.01 = 1e-4
    'cos_lr': True,         # å­¦ä¹ ç‡è°ƒåº¦ï¼šå¼€å¯ä½™å¼¦é€€ç«ï¼ˆCosine Annealingï¼‰ï¼Œè®©æŸå¤±ä¸‹é™æ›´å¹³æ»‘
    'momentum': 0.937,      # åŠ¨é‡ï¼šSGD çš„åŠ¨é‡å‚æ•°ï¼Œå¸®åŠ©ç©¿è¶Šå±€éƒ¨æå°å€¼
    'weight_decay': 0.0005, # æƒé‡è¡°å‡ï¼šL2 æ­£åˆ™åŒ–é¡¹ã€‚0.0005 æ˜¯æ ‡å‡†å€¼ï¼Œç”¨äºé˜²æ­¢æ¨¡å‹å‚æ•°è¿‡å¤§ï¼ˆè¿‡æ‹Ÿåˆï¼‰
    
    # --- 3. è®­ç»ƒé¢„çƒ­ (Warmup) ---
    'warmup_epochs': 3.0,      # é¢„çƒ­è½®æ¬¡ï¼šå‰ 3 è½®å­¦ä¹ ç‡ä»ä½æ…¢æ…¢å‡åˆ° lr0ï¼Œé˜²æ­¢è®­ç»ƒåˆæœŸæ¢¯åº¦çˆ†ç‚¸
    'warmup_momentum': 0.8,    # é¢„çƒ­æœŸå¾…é‡
    'warmup_bias_lr': 0.1,     # é¢„çƒ­åç½®å­¦ä¹ ç‡

    # --- 4. è¾“å…¥ä¸ç³»ç»Ÿè®¾ç½® ---
    'imgsz': 640,           # è¾“å…¥å°ºå¯¸ï¼š640æ˜¯æ ‡å‡†ã€‚æ˜¾å­˜å¤Ÿå¤§(>12G)å¯å°è¯• 1280 æå‡å°ç›®æ ‡æ•ˆæœ
    'seed': 42,             # éšæœºç§å­ï¼šå›ºå®šä¸º 42ï¼Œä¿è¯è®ºæ–‡å®éªŒç»“æœå¯å¤ç°ï¼(éå¸¸é‡è¦)
    'workers': 4,           # æ•°æ®åŠ è½½çº¿ç¨‹æ•°
    'device': 0,            # æŒ‡å®šæ˜¾å¡ ID

    # --- 5. å°ç›®æ ‡ä¸“é¡¹æ•°æ®å¢å¼º (Data Augmentation) ---
    # é’ˆå¯¹å°æ ·æœ¬ï¼Œå¼ºåŠ›çš„å¢å¼ºæ˜¯é˜²æ­¢æ­»è®°ç¡¬èƒŒçš„å…³é”®
    'hsv_h': 0.015,         # è‰²è°ƒå˜åŒ–
    'hsv_s': 0.7,           # é¥±å’Œåº¦å˜åŒ– (æ¨¡æ‹Ÿä¸åŒå¤©æ°”å…‰ç…§)
    'hsv_v': 0.4,           # äº®åº¦å˜åŒ–
    'degrees': 10.0,        # æ—‹è½¬ +/- 10åº¦ (å°ç›®æ ‡å¯¹è§’åº¦æ•æ„Ÿï¼Œä¸å®œè¿‡å¤§)
    'translate': 0.1,       # å¹³ç§» +/- 10%
    'scale': 0.8,           # [å…³é”®] ç¼©æ”¾å¢ç›Šã€‚0.8 è®©å›¾åƒæœ‰æ›´å¤§æ¦‚ç‡è¢«æ”¾å¤§ï¼Œä½¿å°ç›®æ ‡å˜å¤§
    'shear': 0.0,           # å‰ªåˆ‡ (å»ºè®®å…³é—­)
    'perspective': 0.0,     # é€è§† (å»ºè®®å…³é—­)
    'flipud': 0.0,          # ä¸Šä¸‹ç¿»è½¬ (ä¸€èˆ¬å…³é—­)
    'fliplr': 0.5,          # å·¦å³ç¿»è½¬ (å¼€å¯)
    
    # --- 6. é«˜çº§å¢å¼ºç­–ç•¥ ---
    'mosaic': 1.0,          # [å¿…å¼€] é©¬èµ›å…‹å¢å¼ºï¼šæ‹¼æ¥4å¼ å›¾ï¼Œæ˜¾è‘—æå‡å°ç›®æ ‡æ£€æµ‹èƒ½åŠ›
    'mixup': 0.15,          # [æ¨è] æ··åˆå¢å¼ºï¼šä¸¤å›¾å åŠ ï¼Œå¢åŠ é®æŒ¡åœºæ™¯çš„é²æ£’æ€§
    'copy_paste': 0.0,      # å¤åˆ¶ç²˜è´´ (é€šå¸¸ç”¨äºå®ä¾‹åˆ†å‰²ï¼Œæ£€æµ‹ä»»åŠ¡å¯å…³é—­)
    'erasing': 0.4,         # [æ¨è] éšæœºæ“¦é™¤ï¼šéšæœºæŒ–æ‰ä¸€å—ï¼Œå¼ºè¿«æ¨¡å‹è¯†åˆ«ç‰©ä½“å±€éƒ¨ç‰¹å¾
    'close_mosaic': 10,     # [æŠ€å·§] æœ€å 10 ä¸ª epoch å…³é—­ Mosaic å¢å¼ºï¼Œè®©æ¨¡å‹åœ¨çœŸå®åˆ†å¸ƒä¸Šå¾®è°ƒ
}
# ========================================================

def run_comparison():
    print(f"ğŸš€ å¼€å§‹æœºåœºç‰¹ç§è½¦è¾†æ£€æµ‹å¯¹æ¯”å®éªŒ: {list(models_config.keys())}")
    
    # ç¡®ä¿ data.yaml å­˜åœ¨
    if not os.path.exists(DATASET_YAML):
        raise FileNotFoundError(f"âŒ æ‰¾ä¸åˆ° {DATASET_YAML}ï¼Œè¯·ç¡®ä¿å®ƒå’Œè„šæœ¬åœ¨åŒä¸€ç›®å½•ä¸‹ï¼")

    final_results = []

    for display_name, model_file in models_config.items():
        print(f"\n{'='*60}")
        print(f"ğŸ¤– æ­£åœ¨è®­ç»ƒæ¨¡å‹: {display_name} (åŠ è½½æƒé‡: {model_file})")
        print(f"{'='*60}")
        
        try:
            # 1. åŠ è½½æ¨¡å‹
            model = YOLO(model_file)
            
            # 2. è®­ç»ƒ
            model.train(
                data=DATASET_YAML,
                project=PROJECT_NAME,
                name=display_name,
                device=0,           # ä½¿ç”¨ GPU 0
                **HYPERPARAMS
            )
            
            # 3. éªŒè¯ (è·å–æœ€ä½³æƒé‡çš„æŒ‡æ ‡)
            print(f"ğŸ“Š æ­£åœ¨éªŒè¯ {display_name} ...")
            metrics = model.val(split='val', verbose=False)
            
            # 4. è®°å½•ç»“æœ
            result_entry = {
                'Model': display_name,
                'mAP50': round(metrics.box.map50, 4),
                'mAP50-95': round(metrics.box.map, 4),
                'Precision': round(metrics.box.mp, 4),
                'Recall': round(metrics.box.mr, 4),
                'Params': model.info()[1] if model.info() else 0
            }
            final_results.append(result_entry)
            print(f"âœ… {display_name} mAP50: {metrics.box.map50:.3f}")

        except Exception as e:
            print(f"âŒ æ¨¡å‹ {display_name} è®­ç»ƒå‡ºé”™: {e}")

    # ä¿å­˜æœ€ç»ˆ CSV
    if final_results:
        df = pd.DataFrame(final_results)
        df.to_csv(os.path.join(PROJECT_NAME, 'Final_Comparison.csv'), index=False)
        print(f"\nğŸ† å®éªŒç»“æŸï¼ç»“æœå·²ä¿å­˜è‡³ {PROJECT_NAME}/Final_Comparison.csv")

if __name__ == '__main__':
    run_comparison()